# SS220 Agressive melee Combat
- type: htnCompound
  id: MeleeAgressiveCombatCompound
  branches:
  - tasks:
    - !type:HTNPrimitiveTask
      operator: !type:UtilityOperator
        proto: NearbyMeleeTargets
    - !type:HTNCompoundTask
      task: BeforeMeleeAgressiveAttackTargetCompound

- type: htnCompound
  id: BeforeMeleeAgressiveAttackTargetCompound
  branches:
  - preconditions:
    - !type:BuckledPrecondition
      isBuckled: true
    tasks:
    - !type:HTNPrimitiveTask
      operator: !type:UnbuckleOperator
        shutdownState: TaskFinished

  - preconditions:
    - !type:PulledPrecondition
      isPulled: true
    tasks:
    - !type:HTNPrimitiveTask
      operator: !type:UnPullOperator
        shutdownState: TaskFinished

  - preconditions:
    - !type:InContainerPrecondition
      isInContainer: true
    tasks:
    - !type:HTNCompoundTask
      task: EscapeCompound

  - preconditions:
    - !type:ActiveHandComponentPrecondition
      components:
      - type: MeleeWeapon
        damage:
          types:
            Blunt: 0
      invert: true
    tasks:
    - !type:HTNCompoundTask
      task: PickupMeleeCompound

  - tasks:
    - !type:HTNCompoundTask
      task: MeleeAgressiveAttackTargetCompound

- type: htnCompound
  id: RatServantAgressiveCombatCompound
  branches:
  - preconditions:
    - !type:ActiveHandComponentPrecondition
      components:
      - type: MeleeWeapon
        damage:
          types:
            Blunt: 0
      invert: true
    tasks:
    - !type:HTNCompoundTask
      task: PickupMeleeCompound

  - tasks:
    - !type:HTNPrimitiveTask
      operator: !type:UtilityOperator
        proto: OrderedTargets
    - !type:HTNCompoundTask
      task: MeleeAgressiveAttackOrderedTargetCompound

# Tries to melee attack our target.
- type: htnCompound
  id: MeleeAgressiveAttackTargetCompound
  branches:
  - preconditions:
    - !type:KeyExistsPrecondition
      key: Target
    tasks:
    - !type:HTNPrimitiveTask
      operator: !type:MoveToOperator
        shutdownState: PlanFinished
        pathfindInPlanning: true
        removeKeyOnFinish: false
        targetKey: TargetCoordinates
        pathfindKey: TargetPathfind
        rangeKey: MeleeRange
    - !type:HTNPrimitiveTask
      operator: !type:MeleeOperator
        targetKey: Target
      preconditions:
      - !type:KeyExistsPrecondition
         key: Target
      - !type:TargetInRangePrecondition
         targetKey: Target
         rangeKey: MeleeRange
      services:
      - !type:UtilityService
        id: MeleeService
        proto: NearbyMeleeTargets
        key: Target

- type: htnCompound
  id: MeleeAgressiveAttackOrderedTargetCompound
  branches:
  - preconditions:
    - !type:KeyExistsPrecondition
      key: Target
    tasks:
    - !type:HTNPrimitiveTask
      operator: !type:MoveToOperator
        shutdownState: PlanFinished
        pathfindInPlanning: true
        removeKeyOnFinish: false
        targetKey: TargetCoordinates
        pathfindKey: TargetPathfind
        rangeKey: MeleeRange
    - !type:HTNPrimitiveTask
      operator: !type:MeleeOperator
        targetKey: Target
      preconditions:
      - !type:KeyExistsPrecondition
        key: Target
      - !type:TargetInRangePrecondition
        targetKey: Target
        rangeKey: MeleeRange
      services:
      - !type:UtilityService
        id: MeleeService
        proto: OrderedTargets
        key: Target
